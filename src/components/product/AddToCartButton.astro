---
const { productId, buttonText = "Add to cart" } = Astro.props;
---

<script>
  import type { SlButton, SlDialog } from "@shoelace-style/shoelace";
  import { updateCart } from "../../stores/cart";
  import { $counts, getItemCount } from "../../stores/productCounts";

  class AddToCartButton extends HTMLElement {
    constructor() {
      super();

      const productId = this.dataset.id;
      const button = this.querySelector("#add") as SlButton;

      if (!productId || !button) return;

      button.loading = false
      button.disabled = false

      button.addEventListener("click", async () => {
        button.disabled = true;
        button.loading = true;

        try {
          await updateCart(productId, getItemCount(productId));
        } catch (error) {
        } finally {
          button.disabled = false;
          button.loading = false;

          const dialogs = document.querySelectorAll(
            "update-item-dialog",
          ) as NodeListOf<SlDialog>;

          for (const dialog of dialogs) {
            dialog.hide()
          }
        }
      });

      $counts.subscribe((counts) => {
        if (counts[productId] <= 0 || counts[productId] > 10) {
          button.setAttribute("disabled", "true");
        } else {
          button.removeAttribute("disabled");
        }
      });
    }
  }

  customElements.define("add-to-cart-button", AddToCartButton);
</script>

<add-to-cart-button data-id={productId}>
  <sl-button id="add">{buttonText}</sl-button>
</add-to-cart-button>

<style>
  sl-button::part(base) {
    width: 7rem;
  }
</style>