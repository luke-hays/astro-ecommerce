---
import { Image } from "astro:assets";
import { formatNumberToCurrency } from "../../utils/currency";
import ProductCounter from "./ProductCounter.astro";

const { product } = Astro.props;
---

<script>
  import "@shoelace-style/shoelace/dist/components/button/button.js";
  import "@shoelace-style/shoelace/dist/components/icon-button/icon-button.js";
  import "@shoelace-style/shoelace/dist/components/dialog/dialog.js";

  import { $totalCartItems } from "../../stores/totalCartItems";
  import { $counts, getItemCount } from "../../stores/productCounts";
  import { formatNumberToCurrency } from "../../utils/currency";
  import type SlDialog from "@shoelace-style/shoelace/dist/components/dialog/dialog.js";
  import { deleteCartItem, updateCart } from "../../stores/cart";
  import { $products } from "../../stores/products";

  class ProductCard extends HTMLElement {
    constructor() {
      super();

      const id = this.dataset.id;
      const quantity = this.dataset.quantity;
      const price = this.dataset.price;

      const removeButton = this.querySelector(`#remove-${id}`);
      const editButton = this.querySelector(`#edit-${id}`);
      const editDialog = this.querySelector(`#edit-${id}-dialog`) as SlDialog;
      const addToCartButton = this.querySelector("#add-to-cart");

      removeButton?.addEventListener("click", async () => {
        if (id && quantity) {
          removeButton.setAttribute("disabled", "true");
          removeButton.setAttribute("loading", "true");

          try {
            deleteCartItem(id);
            this.remove();
          } catch (error) {
            // TODO Render Error state
          } finally {
            removeButton.removeAttribute("disabled");
            removeButton.removeAttribute("loading");
          }
        }
      });

      editButton?.addEventListener("click", () => {
        editDialog.show();
      });

      if (addToCartButton) {
        addToCartButton.addEventListener("click", async () => {
          addToCartButton.setAttribute("disabled", "true");
          addToCartButton.setAttribute("loading", "true");

          if (!id) return;

          try {
            updateCart(id, getItemCount(id));
            editDialog.hide();
          } catch (error) {
            // TODO Render Error state
          } finally {
            addToCartButton.removeAttribute("disabled");
            addToCartButton.removeAttribute("loading");
          }
        });
      }

      $totalCartItems.subscribe(() => {
        const counts = $counts.get();

        const priceDisplay = this.querySelector("#price");
        if (priceDisplay && price && id) {
          const count = counts[id] ?? quantity;
          priceDisplay.textContent = formatNumberToCurrency(
            parseInt(price) * count,
          );
        }

        const quantityDisplay = this.querySelector("#quantityx");
        if (quantityDisplay && id && quantity) {
          let count = counts[id] ?? quantity;
          quantityDisplay.textContent = `x${count}`;
        }
      });
    }
  }

  customElements.define("product-card", ProductCard);
</script>

<product-card
  class="product"
  data-id={product.id}
  data-quantity={product.quantity}
  data-price={product.price}
>
  <div class="product-image">
    <Image src={product.image()} alt={product.name} />
  </div>
  <div class="product-details">
    <div>
      <div class="name">{product.name}</div>
      <div id="price" class="price">
        {formatNumberToCurrency(product.price * product.quantity)}
      </div>
    </div>

    <div class="product-actions">
      <div id="quantityx" class="quantity">x{product.quantity}</div>
      <div class="controls">
        <sl-button id={`edit-${product.id}`} size="small">Edit</sl-button>
        <sl-button id={`remove-${product.id}`} size="small">Remove</sl-button>
      </div>
    </div>
  </div>
  <sl-dialog
    id={`edit-${product.id}-dialog`}
    label={`Edit ${product.name} Quantity?`}
  >
    <div class="product-dialog">
      <div class="product-image">
        <Image src={product.image()} alt={product.name} />
      </div>
      <div class="update-cart">
        <ProductCounter id={product.id} productQuantity={product.quantity} />
        <sl-button data-product={product.id} id="add-to-cart">
          Update cart
        </sl-button>
      </div>
    </div>
  </sl-dialog>
</product-card>

<style>
  .product {
    display: flex;
    gap: 1rem;
    border: 1px solid var(--color-text-ink-200);
    padding: 1rem 2rem;
    border-radius: 8px;
    background-color: white;
  }

  .product-details {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 0.5rem;
    flex-grow: 1;
  }

  .product-image {
    border-radius: 4px;
    height: 10rem;
    overflow: hidden;
  }

  sl-dialog::part(base) {
    min-height: 20rem;
  }

  .product-image > img {
    width: 100%;
    height: inherit;
    object-fit: cover;
  }

  .product-dialog {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
  }

  .product-dialog > .product-image {
    width: 10rem;
  }

  .name {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--color-text-ink-500);
  }

  .quantity {
    color: var(--color-text-ink-300);
  }

  .price {
    color: var(--color-text-ink-300);
  }

  .product-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .controls {
    display: flex;
    gap: 0.25rem;
    flex-wrap: nowrap;
  }

  .update-cart {
    display: flex;
    gap: 1rem;
  }
</style>
