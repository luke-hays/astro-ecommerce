---
import { getCollection } from "astro:content";

import BaseLayout from "../layouts/BaseLayout.astro";
import ProductCard from "../components/product/ProductCard.astro";

import { getImages } from "../scripts/images";
import { getAllProductsInCart } from "../scripts/product";

const productCollection = await getCollection("products");
const images = getImages();

let cart = {} as Cart;

if (Astro.cookies.has("cart")) {
  const sessionId = Astro.cookies.get("cart")?.value

  if (sessionId) {
    try {
      const url = new URL(`/api/cart?id=${sessionId}`, Astro.url)
      const response = await fetch(url)
      cart = JSON.parse((await response.json())) as Cart
    } catch (error) {
      console.error(error)
    }
  }
}

const products = getAllProductsInCart(productCollection, images, cart)
---

<BaseLayout>
  <div class="checkout-layout">
    <div class="checkout-container">
      <h1>Your cart</h1>
      {
        products.map((product) => {
          return (
            <ProductCard product={product} />
          );
        })
      }
    </div>
  </div>
</BaseLayout>

<style>
  h1 {
    margin: 1rem 0 0 0;
    color: var(--color-text-ink-500);
  }

  .checkout-layout {
    display: flex;
    justify-content: center;
  }

  .checkout-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin: 1rem 2rem;
    min-width: 20rem;
    width: 100%;
    max-width: 40rem;
  }
</style>
